<!DOCTYPE html>
<html>
<head>
  <title>Latent Class Contextual CBC Survey</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    .option { margin: 10px 0; }
    #next-btn { margin-top: 20px; }
  </style>
</head>
<body>
  <h1>Survey</h1>
  <div id="survey-container"></div>
  <button id="next-btn" disabled>Next</button>
  <div id="thankyou" style="display:none;">
    <h2>Thank you for participating!</h2>
  </div>

<script>
const appsScriptUrl = "https://script.google.com/macros/s/AKfycbyimGFCIyYVBHTHb6rAmr2Xh6pgrAm2_BkOlHfRw1FgM2Irf8GmV-6UlG2ZUcS6FCfU/exec";

// Paste your generated tasks.json below:
const tasks = [
  [
  {
    "context": "ContextA",
    "task_id": 1,
    "profiles": [
      {
        "Color": "Blue",
        "Size": "Small",
        "Price": 10
      },
      {
        "Color": "Red",
        "Size": "Large",
        "Price": 10
      },
      {
        "Color": "Red",
        "Size": "Medium",
        "Price": 30
      }
    ]
  },
  {
    "context": "ContextA",
    "task_id": 2,
    "profiles": [
      {
        "Color": "Green",
        "Size": "Medium",
        "Price": 20
      },
      {
        "Color": "Red",
        "Size": "Small",
        "Price": 20
      },
      {
        "Color": "Blue",
        "Size": "Small",
        "Price": 20
      }
    ]
  },
  {
    "context": "ContextA",
    "task_id": 3,
    "profiles": [
      {
        "Color": "Red",
        "Size": "Large",
        "Price": 30
      },
      {
        "Color": "Green",
        "Size": "Medium",
        "Price": 30
      },
      {
        "Color": "Red",
        "Size": "Small",
        "Price": 20
      }
    ]
  },
  {
    "context": "ContextB",
    "task_id": 1,
    "profiles": [
      {
        "Color": "Blue",
        "Warranty": "2 years",
        "Price": 25
      },
      {
        "Color": "Red",
        "Warranty": "2 years",
        "Price": 25
      },
      {
        "Color": "Red",
        "Warranty": "2 years",
        "Price": 25
      }
    ]
  },
  {
    "context": "ContextB",
    "task_id": 2,
    "profiles": [
      {
        "Color": "Red",
        "Warranty": "1 year",
        "Price": 25
      },
      {
        "Color": "Red",
        "Warranty": "2 years",
        "Price": 25
      },
      {
        "Color": "Blue",
        "Warranty": "1 year",
        "Price": 25
      }
    ]
  },
  {
    "context": "ContextB",
    "task_id": 3,
    "profiles": [
      {
        "Color": "Red",
        "Warranty": "2 years",
        "Price": 25
      },
      {
        "Color": "Red",
        "Warranty": "1 year",
        "Price": 15
      },
      {
        "Color": "Red",
        "Warranty": "2 years",
        "Price": 25
      }
    ]
  }
]
];

let currentTaskIndex = 0;
let responses = [];

function renderTask(task) {
  const container = document.getElementById('survey-container');
  container.innerHTML = `<h3>Context: ${task.context} â€” Task ${task.task_id}</h3>`;
  task.profiles.forEach((profile, i) => {
    const desc = Object.entries(profile).map(([k,v]) => `${k}: ${v}`).join(', ');
    container.innerHTML += `
      <div class="option">
        <input type="radio" id="opt${i}" name="choice" value="${i}">
        <label for="opt${i}">${desc}</label>
      </div>
    `;
  });

  document.getElementById('next-btn').disabled = true;

  document.querySelectorAll('input[name="choice"]').forEach(el => {
    el.onchange = () => {
      document.getElementById('next-btn').disabled = false;
    };
  });
}

document.getElementById('next-btn').onclick = () => {
  const selected = document.querySelector('input[name="choice"]:checked');
  if (!selected) {
    alert("Please select an option.");
    return;
  }

  responses.push({
    respondent_id: "R001",
    context: tasks[currentTaskIndex].context,
    task_id: tasks[currentTaskIndex].task_id,
    choice: tasks[currentTaskIndex].profiles[parseInt(selected.value)]
  });

  currentTaskIndex++;

  if (currentTaskIndex < tasks.length) {
    renderTask(tasks[currentTaskIndex]);
  } else {
    submitResponses();
  }
};

function submitResponses() {
  fetch(appsScriptUrl, {
    method: "POST",
    headers: {"Content-Type": "application/json"},
    body: JSON.stringify({responses})
  }).then(res => res.json())
    .then(data => {
      if(data.status === "success") {
        document.getElementById('survey-container').style.display = "none";
        document.getElementById('next-btn').style.display = "none";
        document.getElementById('thankyou').style.display = "block";
      } else {
        alert("Error submitting survey: " + data.message);
      }
    })
    .catch(err => alert("Failed to submit: " + err.message));
}

// Start survey
renderTask(tasks[currentTaskIndex]);
</script>
</body>
</html>
